<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Bus Station</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="shared.css" />

    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        font-family: "Courier New", Courier, monospace;
        color: #fff;
        overflow: hidden;
      }

      #bus-container {
        display: flex;
        flex-direction: column;
        width: 100%;
        height: 100%;
      }

      #schedule-header {
        background: #000;
      }

      #bus-schedule {
        flex: 1;
        width: 100%;
        overflow: hidden;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        align-items: stretch;
        justify-content: stretch;
      }

      .schedule-table {
        width: 100%;
        height: 100%;
        border-collapse: collapse;
        table-layout: fixed;
      }

      .schedule-table th,
      .schedule-table td {
        border: 1px solid #ffffff4d;
        background: #000000;
        text-align: center;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      #id-card-corner {
        position: absolute;
        width: 400px;
        height: 250px;
        transform-origin: top left;
        cursor: pointer;
        transition: 0.1s;
      }

      #id-card-corner.small {
        transform: scale(0.25);
      }

      #id-card-corner.enlarged {
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%) scale(1);
        transition: 0.7s;
      }

      #id-card-perspective {
        width: 100%;
        height: 100%;
        perspective: 1600px;
      }

      #id-card {
        transform-style: preserve-3d;
        transition: transform 0.08s ease;
      }
    </style>
  </head>

  <body>
    <div id="bus-container">
      <div id="schedule-header">
        Veritania Öffentliche Verkehrsbetriebe
        <div class="schedule-meta">
          Haltestelle: ST-14 (Lokalsegment)<br />
          Routencluster: SAND<br />
          Gültigkeit: Unbestimmt<br />
          Zeitformat: 24-Stunden (lokal)<br />
          * Angaben ohne Gewähr. Abweichungen sind systembedingt.
        </div>
      </div>

      <div id="bus-schedule">
        <table class="schedule-table">
          <thead>
            <tr>
              <th>Linie</th>
              <th>Haltestelle</th>
              <th>Abf.</th>
              <th>Ank.</th>
              <th>Steig</th>
              <th>Hinweis*</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>06F</td>
              <td>ST-14</td>
              <td>05:40</td>
              <td>—</td>
              <td>5</td>
              <td>Fahrt vorgesehen</td>
            </tr>
            <tr>
              <td>06F</td>
              <td>ST-14</td>
              <td>06:15</td>
              <td>06:58</td>
              <td>5</td>
              <td>Anschluss nicht garantiert</td>
            </tr>
            <tr>
              <td>06F</td>
              <td>ST-14</td>
              <td>06:45</td>
              <td>—</td>
              <td>5</td>
              <td>Durchführung abhängig</td>
            </tr>
            <tr>
              <td>07K</td>
              <td>ST-14</td>
              <td>07:10</td>
              <td>08:02</td>
              <td>3</td>
              <td>Ziel laut Systemkern</td>
            </tr>
            <tr>
              <td>07K</td>
              <td>ST-14</td>
              <td>07:55</td>
              <td>—</td>
              <td>3</td>
              <td>Verzögerung möglich</td>
            </tr>
            <tr>
              <td>08M</td>
              <td>ST-14</td>
              <td>08:30</td>
              <td>09:20</td>
              <td>2</td>
              <td>Kapitalzone (bedingt)</td>
            </tr>
            <tr>
              <td>08M</td>
              <td>ST-14</td>
              <td>09:00</td>
              <td>—</td>
              <td>2</td>
              <td>Zuweisung ausstehend</td>
            </tr>
            <tr>
              <td>09R</td>
              <td>ST-14</td>
              <td>09:35</td>
              <td>10:10</td>
              <td>TBD</td>
              <td>Steig wird ermittelt</td>
            </tr>
            <tr>
              <td>09R</td>
              <td>ST-14</td>
              <td>10:05</td>
              <td>—</td>
              <td>TBD</td>
              <td>Fahrt ggf. entfällt</td>
            </tr>
            <tr>
              <td>10C</td>
              <td>ST-14</td>
              <td>10:40</td>
              <td>11:30</td>
              <td>1</td>
              <td>Direktführung intern</td>
            </tr>
            <tr>
              <td>10C</td>
              <td>ST-14</td>
              <td>11:15</td>
              <td>—</td>
              <td>1</td>
              <td>Freigabe ausstehend</td>
            </tr>
            <tr>
              <td>11S</td>
              <td>ST-14</td>
              <td>11:50</td>
              <td>12:45</td>
              <td>4</td>
              <td>Kapazität begrenzt</td>
            </tr>
            <tr>
              <td>11S</td>
              <td>ST-14</td>
              <td>12:30</td>
              <td>—</td>
              <td>4</td>
              <td>Systemprüfung aktiv</td>
            </tr>
            <tr>
              <td>12A</td>
              <td>ST-14</td>
              <td>13:05</td>
              <td>13:55</td>
              <td>6</td>
              <td>Zielvariable</td>
            </tr>
            <tr>
              <td>12A</td>
              <td>ST-14</td>
              <td>13:40</td>
              <td>—</td>
              <td>6</td>
              <td>Keine Prognose</td>
            </tr>
            <tr>
              <td>13L</td>
              <td>ST-14</td>
              <td>14:20</td>
              <td>15:05</td>
              <td>5</td>
              <td>Weiterfahrt optional</td>
            </tr>
            <tr>
              <td>13L</td>
              <td>ST-14</td>
              <td>15:00</td>
              <td>—</td>
              <td>5</td>
              <td>Status offen</td>
            </tr>
            <tr>
              <td>14X</td>
              <td>ST-14</td>
              <td>15:40</td>
              <td>—</td>
              <td>TBD</td>
              <td>Keine Anzeige verfügbar</td>
            </tr>
            <tr>
              <td>—</td>
              <td>ST-14</td>
              <td>—</td>
              <td>—</td>
              <td>—</td>
              <td>Weitere Fahrten nicht erfasst</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="id-card-corner">
        <div id="id-card-perspective">
          <div id="id-card">
            <div id="id-header">
              <img src="./assets/images/Sato-Flag.jpg" alt="" class="id-flag" />
              <span id="id-title"
                >ALIEN PROCESSING DEPARTMENT <br />
                STATE OF VERIATNIA
              </span>
              <div id="id-score">
                <span id="score-title">SCORE</span><br />
                <span id="score-value"></span>
              </div>
            </div>
            <div class="flex_row">
              <div id="id-image-frame">
                <div class="tilt-card" id="id-tilt-card">
                  <img
                    id="final-image"
                    class="tilt-img img-a"
                    src=""
                    alt="Standard image"
                  />
                  <img class="tilt-img img-b" src="" alt="Tilt image" />
                </div>
              </div>
              <div id="id-stats">
                <div><span>@</span><span id="id-name"></span></div>
                <br />
                <div>
                  <span class="stat">CONDEMNED BY: </span><br /><span
                    id="stat-born"
                    class="stat_value"
                  ></span>
                </div>
                <br />
                <div>
                  <span class="stat">DEFINED BY: </span><br /><span
                    id="stat-fled"
                    class="stat_value"
                  ></span>
                </div>
                <br />
                <div>
                  <span class="stat">TIME OF CONDEMNATION: </span><br /><span
                    id="stat-date"
                    class="stat_value"
                  ></span>
                </div>
                <br />
                <div>
                  <span class="stat">HEIGHT: </span><br /><span
                    id="stat-height"
                    class="stat_value"
                  ></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      /* ==========================
   Load stored data
========================== */
      const savedData =
        JSON.parse(localStorage.getItem("immigrationResult")) || {};

      const {
        name = "NAME",
        birthplace = "",
        birthdate = "",
        height = "",
        escape = "",
        score = 0,
        chosenImage = "",
        altImage = "",
      } = savedData;

      document.getElementById("id-name").textContent = name;
      document.getElementById("score-value").textContent = score;

      document.getElementById("stat-born").textContent = birthplace;
      document.getElementById("stat-fled").textContent = escape;
      document.getElementById("stat-date").textContent = birthdate;
      document.getElementById("stat-height").textContent = height;

      const imgA = document.querySelector(".img-a");
      const imgB = document.querySelector(".img-b");

      if (imgA && chosenImage) imgA.src = chosenImage;
      if (imgB && altImage) imgB.src = altImage;

      /* ==========================
   Elements
========================== */
      const corner = document.getElementById("id-card-corner");
      const perspective = document.getElementById("id-card-perspective");
      const card = document.getElementById("id-card");

      /* ==========================
   State
========================== */
      let enlarged = false;
      const smallScale = 0.35;
      const offset = 20;
      let lastMouseX = 0;
      let lastMouseY = 0;

      /* ==========================
   Mouse move
========================== */
      document.addEventListener("mousemove", (e) => {
        lastMouseX = e.clientX;
        lastMouseY = e.clientY;
        if (!enlarged) {
          corner.style.left = `${e.clientX + offset}px`;
          corner.style.top = `${e.clientY + offset}px`;
          corner.style.transform = `scale(${smallScale})`;

          card.style.transform = "rotateX(0deg) rotateY(0deg)";
          imgA.style.opacity = 1;
          imgB.style.opacity = 0;
          return;
        }

        const rect = card.getBoundingClientRect();
        const cx = rect.left + rect.width / 2;
        const cy = rect.top + rect.height / 2;

        const nx = (e.clientX - cx) / (rect.width / 2);
        const ny = (cy - e.clientY) / (rect.height / 2);

        const clampedX = Math.max(-1, Math.min(1, nx));
        const clampedY = Math.max(-1, Math.min(1, ny));

        const maxRotX = 18;
        const maxRotY = 35;

        const rotX = clampedY * maxRotX;
        const rotY = clampedX * maxRotY;

        card.style.transform = `rotateX(${rotX}deg) rotateY(${rotY}deg)`;

        const revealAngle = 6; // degrees before alt image starts appearing

        let fade = (Math.abs(rotY) - revealAngle) / (maxRotY - revealAngle);
        fade = Math.max(0, Math.min(1, fade));

        imgB.style.opacity = fade;
        imgA.style.opacity = 1 - fade;
      });

      document.addEventListener("click", () => {
        enlarged = !enlarged;

        if (enlarged) {
          corner.classList.add("enlarged");
          corner.style.left = "";
          corner.style.top = "";
          corner.style.transform = "translate(-92%, -92%) scale(1)";
        } else {
          corner.classList.remove("enlarged");
          card.style.transform = "rotateX(0deg) rotateY(0deg)";

          corner.style.left = `${lastMouseX + offset}px`;
          corner.style.top = `${lastMouseY + offset}px`;
          corner.style.transform = `scale(${smallScale})`;
        }
      });
    </script>
  </body>
</html>
